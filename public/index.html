<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
    <style>
    body {
      transition: 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
    }
    html, body {
      width: 100%;
      height: 100%;
    }
    #app {
      margin: 8px 0;
    }
    video {
      background-image: none;
      overflow: hidden;
      border-radius: 100%;
      width: 80px;
      height: 80px;
      position: absolute;
      transition: 0.4s;
      transition-timing-function: ease;
      top: 343px;
      z-index: 4;
    }
    #end-call {
      border: none;
      background-color: transparent;
      width: 190px;
      height: 38px;
      z-index: 5;
      outline: none;
      margin: 0;
      padding: 0;
      position: absolute;
      margin-top: 430px;
    }
    video:last-of-type {
      background-image: url('video-background.png');
      background-position: center;
      background-size: 100%;
      background-repeat: no-repeat;
      position: absolute;
      top: 86px;
      z-index: 3;
      width: 290px;
      height: 290px;
      border-radius: 100%;
      transition: 0.4s;
    }
    video:first-of-type {
      object-fit: cover;
      background-image: none;
    }
    .btns {
      display: flex;
      border-radius: 30px;
      background-color: #e7e7e7;
      flex-direction: column;
      align-items: center;
      margin: 0 8px;
      padding: 8px 4px;
    }
    button {
      background-color: transparent;
      border: none;
      width: 22px;
      height: 22px;
      color: transparent;
      margin: 0;
      padding: 0;
      border-radius: 100%;
      transition: 0.2s;
      outline: none;
    }
    button#enlarge {
      width: 40px;
      height: 40px;
      z-index: 5;
      background-color: #d5d5d5;
      border: none;
      border-radius: 100%;
      position: absolute;
      margin-top: 80px;
      margin-left: 80px;
    }
    button:hover {
      background-color: white;
    }
    button img {
      transition: 0.2s;
      cursor: pointer;
    }
    button:hover img {
      transform: scale(0.8);
    }
    button#enlarge:hover {
      background-color: white;
    }
    button#enlarge:hover img {
      transform: scale(1);
    }
    textarea {
      box-shadow: inset 0 0 20px 10px white;
      background-color: #e7e7e7;
      width: 70%;
      height: 44px;
      padding: 8px;
      border: 1px solid #888888;
      font-family: Helvetica;
      font-size: 10pt;
      font-weight: 100;
      resize: none;
      border-radius: 6px;
      transition: 0.3s;
      outline: none;
    }
    textarea:focus {
      transform: scale(1.02);
    }
    h5 {
      border-top: 1px solid #d5d5d5;
      display: block;
      text-align: center;
      font-family: Avenir;
      font-size: 6pt;
      letter-spacing: 1px;
      font-style: italic;
      padding-top: 4px;
      color: #414141;
      transform: scale(1, 1.5);
    }
    h3 {
      display: block;
      text-align: left;
      font-family: Avenir;
      font-size: 6pt;
      letter-spacing: 1px;
      font-style: italic;
      color: #888888;
      transform: scale(1, 1.5);
    }
    form {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      position: absolute;
      bottom: 0;
      right: 9;
      width: 100%;
      padding: 10px 0;
      height: 62px;
      transition: 0.3s;
      background-color: #d5d5d5;
      box-shadow: 0px 2px 2px #888888;
    }
    #pop-up {
      transition: 0.3s;
      position: relative;
      border-radius: 3px;
      border: 1px solid #d5d5d5;
      box-shadow: 0 2px 2px #888888;
      margin: 0 auto;
      width: 340px;
      height: 540px;
      background-color: #e7e7e7;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 82px;
    }
    span {
      display: block;
      transform: scale(1, 1.5);
      font-family: Avenir;
      font-style: italic;
      font-weight: bold;
      font-size: 26pt;
      padding: 20px 0;
    }
    p {
      font-family: Helvetica Neue;
      font-weight: 200;
      font-size: 12pt;
    }
    h2 {
      display: block;
      border-radius: 100%;
      background: black;
      width: 25px;
      height: 25px;
      box-sizing: border-box;
      border: 3px solid white;
      color: white;
      font-family: Helvetica;
      font-size: 8pt;
      padding: 3px 6px;
      text-align: center;
      position: absolute;
      top: 8px;
      left: 8px;
    }
    h2:last-of-type {
      margin-left: 16px;
    }
    ul {
      list-style-type: none;
      width: 100%;
      display: block;
      box-sizing: border-box;
      margin: 0;
      padding: 12px;
      max-height: 400px;
      overflow: scroll;
    }
    p#users {
      transform: scale(0.8, 0.9);
      font-style: italic;
      margin: 0;
      font-size: 10pt;
    }
    li {
      border-radius: 20px;
      background-color: white;
      padding: 8px 12px;
      font-family: Helvetica Neue, Helvetica;
      font-weight: 400;
      text-align: left;
      font-size: 10pt;
      margin: 2px 0;
    }
    #window {
      position: absolute;
      bottom: 0;
      right: 0;
      height: 85%;
      padding: 0 8px;
      z-index: 2;
      background-color: #d5d5d5;
    }
    #window > p {
      padding: 0 16px;
    }
    #window > input[type=text] {
      width: 100%;
      box-sizing: border-box;
      height: 38px;
      font-family: Helvetica;
      font-weight: 100;
      font-size: 12pt;
      padding: 0 16px;
      background-color: #d5d5d5;
      outline: none;
      border-radius: 6px;
      border: 1px solid #888888;
      border-left: none;
      border-right: none;
      transition: 0.2s;
    }
    #window > input[type=text]:hover {
      border-top: 3px solid #888888;
      border-bottom: 3px solid #888888;
      box-shadow: inset 0 0 20px 10px #e7e7e7;
    }
    #window > input[type=text]:focus {
      border-top: 3px solid #888888;
      border-bottom: 3px solid #888888;
      box-shadow: inset 0 0 20px 10px #e7e7e7;
    }
    input[type=submit] {
      display: block;
      width: 90px;
      font-family: Avenir;
      font-style: italic;
      font-size: 12pt;
      font-weight: bold;
      transform: scale(0.9, 1.1);
      height: 30px;
      border-radius: 4px;
      box-shadow: 0 1px 2px 0 #888888;
      background-color: white;
      border: 1px solid #d5d5d5;
      margin: 20px 0;
      transition: 0.2s;
    }
    input[type=submit]:hover {
      /* filter: invert(1); */
      background-color: black;
      color: white;
      cursor: pointer;
    }
    input[type=submit]:focus {
      background-color: white;
      color: black;
      box-shadow: 0 1px 3px 0 #e7e7e7;
    }
    </style>
  </head>
  <body>
    <div id="app"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
    <script src="PeerConnection.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="app.js"></script>
    <script>
    function getUserMedia(callback) {
      var hints = {
        audio: true,
        video: {
          optional: [],
          mandatory: {
            minWidth: 1280,
            minHeight: 720,
            maxWidth: 1920,
            maxHeight: 1080,
            minAspectRatio: 1.77
          }
        }
      };
      navigator.mediaDevices.getUserMedia(hints).then(function (stream) {
        callback(stream);
        var video = document.createElement('video');
        video.srcObject = stream;
        video.controls = false;
        video.autoplay = true;
        video.muted = true;
        video.id = 'me';
        peer.onStreamAdded({
          mediaElement: video,
          userid: 'self',
          stream: stream
        });
      });
    }
    function renderEndButton() {
      var button = document.createElement('button')
      button.id = 'end-call'
      var img = document.createElement('img')
      img.src = 'end_call.svg'
      img.width = '190'
      img.height = '38'
      button.appendChild(img)
      button.onclick = function() {
        peer.close()
        document.getElementById('pop-up').style.opacity = '1'
        document.body.style.backgroundColor = 'white'
        document.getElementById('me').remove()
        document.getElementById(window.offerer).remove()
        document.getElementById('end-call').remove()
        document.getElementById('enlarge').remove()
      }
      document.body.appendChild(button)
    }
    function renderEnlargeButton() {
      var button = document.createElement('button')
      button.id = 'enlarge'
      var img = document.createElement('img')
      img.src = 'enlarge.svg'
      img.width = '25'
      img.height = '25'
      button.appendChild(img)
      button.onclick = function() {
        // document.getElementById(window.offerer).style.top = ''
        // document.getElementById(window.offerer).style.width = ''
        // document.getElementById(window.offerer).style.height = ''
        // document.getElementById(window.offerer).style.objectFit = ''
        // document.getElementById(window.offerer).style.backgroundImage = ''
        // document.getElementById(window.offerer).style.borderRadius = ''
        // document.getElementById('me').style.right = ''
        // document.getElementById('me').style.margin = ''
        // document.getElementById('me').style.width = ''
        // document.getElementById('me').style.height = ''
        // document.getElementById('me').style.top = ''
        // document.getElementById('me').style.borderRadius = ''
        // document.getElementById('me').style.border = ''
      }
      document.body.appendChild(button)
    }
    var peer = new PeerConnection('http://localhost:8989')
    peer.onStreamAdded = function(e) {
      if (e.participantid) {
        renderEndButton()
        renderEnlargeButton()
      }
      document.body.appendChild(e.mediaElement)
    }
    $(document).ready(function() {
      var socket = io()
      socket.emit('chat message', 'bot⍄user can be reached at ' + peer.userid)
      $('form').submit(function(e) {
        e.preventDefault()
        var text = $('#m').val()
        if (text.length > 0) {
          var users = $('#users').text()
          var sender = users.split(' > ')
          var body = sender[0] + '⍄' + text
          socket.emit('chat message', body)
          $('#m').val('')
          console.log('Message sent!')
        }
      })
      socket.on('chat message', function(msg) {
        var body = msg.split('⍄')
        var users = $('#users').text()
        var sender = users.split(' > ')
        if (body.length > 2 && body[0] !== sender[0]) {
          msg = [body[0], body[1]].join('⍄')
          window.offerer = body[2]
          if (!peer.MediaStream) getUserMedia(stream => peer.addStream(stream))
        } else if (body.length > 2 && body[0] === sender[0]) {
          msg = [body[0], body[1]].join('⍄')
          if (!peer.MediaStream) getUserMedia(stream => peer.addStream(stream))
        }
        if (body[1].length > 0) {
          var el = $('<h3>').text('-' + body[0])
          var message = $('<li>').text(msg.slice(msg.indexOf('⍄') + 1, msg.length))
          $('#messages').append(message)
          $('#messages').append(el)
          document.getElementById('messages').scrollTo(0, document.getElementById('messages').scrollHeight)
        }
      })
    })
    </script>
  </body>
</html>
